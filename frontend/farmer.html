<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VanaspatiSetu - Farmer Collection Portal</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=DM+Sans:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="farmer.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  </head>
  <body>
    <nav class="navbar">
  <div class="logo">VanaspatiSetuüåø</div>
  <div class="nav-links">
    <a href="index.html">Home</a>
    <a href="farmer.html">Farmer</a>
    <a href="processor.html">Processor</a>
    <a href="lab.html">Lab</a>
  </div>
</nav>

    <div class="grain-overlay"></div>

    <header>
      <div class="header-content">
        <div class="logo">VanaspatiSetu Farmer</div>
        <div class="user-info">
          <div class="user-avatar">üë®‚Äçüåæ</div>
          <div>
            <div style="font-weight: 600">Ramesh Kumar</div>
            <div style="font-size: 0.85rem; opacity: 0.8">ID: FK_2341</div>
          </div>
        </div>
      </div>
    </header>

    <div class="container">
      <div class="dashboard-header">
        <h1>Farmer Collection Portal</h1>
        <p>
          Record your harvests securely on the blockchain with instant
          verification
        </p>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value">47</div>
          <div class="stat-label">Total Harvests</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">‚Çπ2.3L</div>
          <div class="stat-label">Earnings (2026)</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">98%</div>
          <div class="stat-label">Approval Rate</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">12</div>
          <div class="stat-label">Days Avg Payment</div>
        </div>
      </div>

      <div class="season-info">
        <h3>üå± Current Season Information</h3>
        <p>
          <strong>Active Season:</strong> Ashwagandha (Nov - Feb), Tulsi
          (Year-round), Brahmi (Oct - Mar)
        </p>
        <p><strong>Allowed Zones:</strong></p>
        <div class="zones-allowed">
          <span class="zone-tag">üìç Nagpur District</span>
          <span class="zone-tag">üìç Satara District</span>
          <span class="zone-tag">üìç Kottayam District</span>
          <span class="zone-tag">üìç Nashik District</span>
        </div>
      </div>

      <div id="alertBox" class="alert"></div>

      <div class="collection-form">
        <h2>üìù Record New Harvest</h2>
        <form id="harvestForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="herbType">Herb Type *</label>
              <select id="herbType" required>
                <option value="">Select herb...</option>
                <option value="ashwagandha">Ashwagandha Root</option>
                <option value="tulsi">Tulsi Leaves</option>
                <option value="brahmi">Brahmi Plant</option>
                <option value="neem">Neem Leaves</option>
              </select>
            </div>

            <div class="form-group">
              <label for="quantity">Quantity (kg) *</label>
              <input
                type="number"
                id="quantity"
                placeholder="e.g., 50"
                required
                min="1"
              />
            </div>

            <div class="form-group">
              <label for="location">Location *</label>
              <select id="location" required>
                <option value="">Select location...</option>
                <option value="nagpur">Nagpur District, Maharashtra</option>
                <option value="satara">Satara District, Maharashtra</option>
                <option value="kottayam">Kottayam District, Kerala</option>
                <option value="nashik">Nashik District, Maharashtra</option>
                <option value="pune">
                  Pune District, Maharashtra (Out of zone)
                </option>
              </select>
            </div>

            <div class="form-group">
              <label for="harvestDate">Harvest Date *</label>
              <input type="date" id="harvestDate" required />
            </div>
          </div>

          <div class="form-group">
            <label for="notes">Additional Notes</label>
            <textarea
              id="notes"
              rows="3"
              placeholder="Any special conditions, quality observations, etc."
            ></textarea>
          </div>

          <div class="gps-display" id="gpsDisplay">
            <div class="gps-info">
              <div>
                <strong>GPS Location:</strong>
                <div
                  id="gpsCoords"
                  style="font-family: monospace; margin-top: 0.25rem"
                ></div>
              </div>
              <div style="font-size: 2rem">üìç</div>
            </div>
          </div>

          <div class="btn-group">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="captureGPS()"
            >
              üìç Capture GPS
            </button>
            <button type="submit" class="btn btn-primary">
              Submit Harvest Record
            </button>
          </div>
        </form>
        
        <div class="qr-output" style="margin-top:30px; display:none;" id="qrSection">
  <h3>Generated QR Code</h3>
  <div id="qrcode" style="margin:15px 0;"></div>
  <p><strong>Batch ID:</strong> <span id="generatedBatch"></span></p>
  <p><strong>Verify URL:</strong> <a id="verifyUrl" href="#" target="_blank"></a></p>
  <button onclick="downloadQR()" class="btn btn-primary">Download QR</button>
</div>

      <div class="recent-harvests">
        <h2>üìã Recent Harvest Records</h2>
        <table class="harvest-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Herb</th>
              <th>Quantity</th>
              <th>Location</th>
              <th>Status</th>
              <th>Payment</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Jan 28, 2026</td>
              <td>Ashwagandha</td>
              <td>65 kg</td>
              <td>Nagpur, MH</td>
              <td>
                <span class="status-badge status-approved">Approved</span>
              </td>
              <td>‚Çπ17,550</td>
            </tr>
            <tr>
              <td>Jan 15, 2026</td>
              <td>Tulsi</td>
              <td>42 kg</td>
              <td>Satara, MH</td>
              <td>
                <span class="status-badge status-approved">Approved</span>
              </td>
              <td>‚Çπ8,820</td>
            </tr>
            <tr>
              <td>Jan 8, 2026</td>
              <td>Brahmi</td>
              <td>38 kg</td>
              <td>Kottayam, KL</td>
              <td>
                <span class="status-badge status-approved">Approved</span>
              </td>
              <td>‚Çπ13,680</td>
            </tr>
            <tr>
              <td>Dec 22, 2025</td>
              <td>Ashwagandha</td>
              <td>58 kg</td>
              <td>Nagpur, MH</td>
              <td>
                <span class="status-badge status-approved">Approved</span>
              </td>
              <td>‚Çπ15,660</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <input id="batchId" placeholder="Enter Batch ID">

    <button id="registerBtn" class="btn btn-primary">
  Register Batch (Blockchain)
</button>


    <footer>
      <p>
        <strong>VanaspatiSetu Farmer Portal</strong> - Empowering farmers through
        transparent trade
      </p>
      <p style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.8">
        Blockchain-verified collections | Fair pricing guaranteed
      </p>
    </footer>

    <script>
const API = (window.API_BASE_URL || "https://innovit-hackhers.onrender.com").replace(/\/+$/, "");

/* ================= RULES ================= */

const validationRules = {
  ashwagandha: {
    season: { months: [11,12,1,2], name: "November to February" },
    zones: ["nagpur", "nashik"],
  },
  tulsi: {
    season: { months: [1,2,3,4,5,6,7,8,9,10,11,12], name: "Year-round" },
    zones: ["nagpur", "satara", "nashik"],
  },
  brahmi: {
    season: { months: [10,11,12,1,2,3], name: "October to March" },
    zones: ["kottayam"],
  },
  neem: {
    season: { months: [3,4,5,6], name: "March to June" },
    zones: ["nagpur", "satara", "nashik"],
  },
};

let currentGPS = null;

/* ================= GPS ================= */

function captureGPS() {
  navigator.geolocation.getCurrentPosition(
    pos => {
      currentGPS = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      document.getElementById("gpsCoords").textContent =
        `${currentGPS.lat.toFixed(6)}, ${currentGPS.lng.toFixed(6)}`;
      document.getElementById("gpsDisplay").classList.add("active");
    },
    () => {
      currentGPS = { lat: 21.1458, lng: 79.0882 };
      document.getElementById("gpsCoords").textContent =
        `${currentGPS.lat.toFixed(6)}, ${currentGPS.lng.toFixed(6)} (Demo)`;
      document.getElementById("gpsDisplay").classList.add("active");
    }
  );
}

/* ================= SUBMIT ================= */

document.getElementById("harvestForm").addEventListener("submit", submitHarvest);

async function submitHarvest(e) {
  e.preventDefault();

  const herb = document.getElementById("herbType").value;
  const quantity = document.getElementById("quantity").value;
  const location = document.getElementById("location").value;
  const harvestDate = document.getElementById("harvestDate").value;
  const notes = document.getElementById("notes").value;

  if (!herb || !quantity || !location || !harvestDate || !currentGPS) {
    showAlert("error", "Validation Error", "Fill all fields and capture GPS.");
    return;
  }

  const rules = validationRules[herb];
  const month = new Date(harvestDate).getMonth() + 1;

  if (!rules.season.months.includes(month)) {
    showAlert("error", "Out of Season", rules.season.name);
    return;
  }

  if (!rules.zones.includes(location)) {
    showAlert("error", "Out of Zone", rules.zones.join(", "));
    return;
  }

  const batchId = generateBatchId(herb);

  const payload = {
    batchId,
    herb,
    quantity,
    location,
    harvestDate,
    gps: currentGPS,
    notes,
    farmerName: "Ramesh Kumar"
  };

  try {
    const res = await fetch(`${API}/api/harvest`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (!res.ok) {
      alert("‚ùå Backend Error: " + (data.error || "Unknown"));
      return;
    }

    showAlert("success", "Harvest Recorded", `Batch ID: ${batchId}`);

    generateAndShowQR(batchId);
    await autoRegisterOnChain(batchId);

    document.getElementById("harvestForm").reset();
    document.getElementById("gpsDisplay").classList.remove("active");
    currentGPS = null;

  } catch (err) {
    alert("‚ùå Backend server not reachable");
    console.error(err);
  }
}

/* ================= QR ================= */

function generateAndShowQR(batchId) {
  const verifyLink = `index.html?batch=${batchId}`;

  generatedBatch.textContent = batchId;

  verifyUrl.innerText = verifyLink;
  verifyUrl.href = verifyLink;

  qrcode.innerHTML = "";

  new QRCode(qrcode, {
    text: verifyLink,
    width: 180,
    height: 180,
  });

  qrSection.style.display = "block";
}

function downloadQR() {
  const img = document.querySelector("#qrcode img");
  if (!img) return alert("QR not ready");

  const a = document.createElement("a");
  a.href = img.src;
  a.download = "batch_qr.png";
  a.click();
}

/* ================= HELPERS ================= */

function generateBatchId(herb) {
  const year = new Date().getFullYear();
  const rand = Math.floor(100 + Math.random() * 900);
  return `${herb.toUpperCase()}_${year}_${rand}`;
}

function showAlert(type, title, message) {
  const box = document.getElementById("alertBox");
  box.className = `alert ${type}`;
  box.innerHTML = `<h3>${title}</h3><p>${message}</p>`;
  box.style.display = "block";
  setTimeout(() => box.style.display = "none", 6000);
}

/* ================= DEFAULT DATE ================= */

harvestDate.valueAsDate = new Date();


</script>


  </body>
</html>
