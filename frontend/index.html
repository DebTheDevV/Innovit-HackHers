<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VanaspatiSetu - Transparent Herbal Supply Chain</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=DM+Sans:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="index.css" />
  </head>

  <script type="module">
  import { connectWallet } from "./src/web3.js";

  document.getElementById("connectWallet").onclick = async () => {
    const addr = await connectWallet();
    alert("Connected: " + addr);
  };
</script>

  <body>
   

    <div class="grain-overlay"></div>

    <header>
      <div class="header-content">
        
      <nav class="navbar">
  <div class="logo">VanaspatiSetuğŸŒ¿</div>

  <div class="nav-links">
    <a href="index.html">Home</a>
    <a href="farmer.html">Farmer</a>
    <a href="processor.html">Processor</a>
    <a href="lab.html">Lab</a>
  </div>

 <button id="connectWallet">ğŸ” Connect Wallet</button>
</nav>
    </header>

    <div class="container">
      <div class="hero">
        <h1>From Soil to Shelf</h1>
        <p>
          Every herb has a story. Verify the complete journey of your herbal
          products with blockchain-powered transparency.
        </p>
      </div>

      <div class="search-section" id="verify">
        <h2>Verify Your Product</h2>
        <div class="qr-input-group">
          <input
            type="text"
            class="qr-input"
            id="batchInput"
            placeholder="Enter Batch ID (e.g., ASHW_2026_001) or scan QR code"
          />
          <button class="btn btn-primary" onclick="verifyBatch()">
            Verify
          </button>
        </div>
        <p style="margin-bottom: 1rem; color: var(--earth-600)">
          Try our sample batches:
        </p>
        <div class="quick-samples">
          <button class="sample-btn" onclick="loadBatch('ASHW_2026_001')">
            Ashwagandha Capsules
          </button>
          <button class="sample-btn" onclick="loadBatch('TULSI_2026_042')">
            Tulsi Tea Blend
          </button>
          <button class="sample-btn" onclick="loadBatch('BRAHMI_2026_018')">
            Brahmi Extract
          </button>
        </div>
      </div>

      <div id="batchDetails" class="batch-details">
        <div class="batch-header">
          <div class="qr-display">ğŸ“±</div>
          <div class="batch-info">
            <h2 id="productName">Loading...</h2>
            <div class="batch-meta">
              <strong>Batch ID:</strong> <span id="batchId"></span> |
              <strong>Manufactured:</strong> <span id="mfgDate"></span>
            </div>
          </div>
          <div class="status-badge status-verified">âœ“ Verified</div>
        </div>

        <div class="timeline">
          <h3>ğŸŒ± Journey Timeline</h3>
          <div id="timelineContent"></div>
        </div>

        <div class="grid-2">
          <div class="card">
            <h3>ğŸ“ Origin Map</h3>
            <div id="map"></div>
            <div
              style="
                margin-top: 1rem;
                color: var(--earth-600);
                font-size: 0.9rem;
              "
            >
              <strong>Location:</strong> <span id="location"></span>
            </div>
          </div>

          <div class="card">
            <h3>ğŸ”¬ Lab Test Results</h3>
            <div id="testResults" class="test-results"></div>
          </div>
        </div>

        <div class="fair-trade">
          <h3>ğŸ’° Fair Trade & Sustainability</h3>
          <div class="payment-details" id="paymentDetails"></div>
        </div>
      </div>
    </div>

    <footer>
      <div class="footer-content">
        <p>
          <strong>VanaspatiSetu</strong> - Powered by Hyperledger Fabric Blockchain
        </p>
        <p>
          Ensuring transparency, quality, and fair practices in the herbal
          supply chain
        </p>
        <p style="font-size: 0.85rem; margin-top: 1.5rem">
          Â© 2026 VanaspatiSetu Project. Built for transparency and trust.
        </p>
      </div>
    </footer>

    <script>
const API = "https://innovit-hackhers.onrender.com/";
let map;

function verifyBatch() {
  const input = document
    .getElementById("batchInput")
    .value.trim()
    .toUpperCase();
  if (!input) return;
  loadBatch(input);
}

async function loadBatch(batchId) {
  try {
    const res = await fetch(`${API}/api/batch/${batchId}`);
    const data = await res.json();

    if (!res.ok) {
      alert("âŒ Batch not found");
      return;
    }

    renderBatch(data);

  } catch (err) {
    alert("âŒ Backend not reachable");
    console.error(err);
  }
}

function renderBatch(data) {
  let timeline = [];

  timeline.push({
    icon: "ğŸŒ¿",
    title: "Harvested",
    date: new Date(data.harvestDate).toDateString(),
    details: {
      Herb: data.herb,
      Quantity: data.quantity + " kg",
      GPS: `${data.gps.lat}, ${data.gps.lng}`,
      Location: data.location
    }
  });

  if (data.processing) {
    timeline.push({
      icon: "ğŸ­",
      title: "Processed",
      date: new Date(data.processing.timestamp).toDateString(),
      details: {
        Method: data.processing.method,
        Facility: data.processing.facility,
        Operator: data.processing.operator
      }
    });
  }

  if (data.lab) {
    timeline.push({
      icon: "ğŸ§ª",
      title: "Lab Verified",
      date: new Date(data.lab.testDate).toDateString(),
      details: {
        Moisture: data.lab.moisture + "%",
        Compound: data.lab.compound + "%",
        Microbial: data.lab.microbial,
        HeavyMetal: data.lab.heavyMetal,
        Purity: data.lab.purity,
        Lab: data.lab.labName
      }
    });
  }

  document.getElementById("productName").textContent =
    data.herb.toUpperCase() + " Product";

  document.getElementById("batchId").textContent = data.batchId;

  document.getElementById("mfgDate").textContent =
    new Date(data.harvestDate).toDateString();

  document.getElementById("location").textContent = data.location;

  document.getElementById("timelineContent").innerHTML = timeline
    .map(
      item => `
      <div class="timeline-item">
        <div class="timeline-icon">${item.icon}</div>
        <div class="timeline-content">
          <h4>${item.title}</h4>
          <div class="timeline-date">${item.date}</div>
          <div class="timeline-details">
            ${Object.entries(item.details)
              .map(([k,v]) => `<div class="detail-row"><b>${k}:</b> ${v}</div>`)
              .join("")}
          </div>
        </div>
      </div>
    `
    )
    .join("");

  if (data.lab) {
    document.getElementById("testResults").innerHTML = `
      <div class="test-item pass">
        <div class="test-name">Moisture</div>
        <div class="test-value">${data.lab.moisture}%</div>
      </div>
      <div class="test-item pass">
        <div class="test-name">Active Compound</div>
        <div class="test-value">${data.lab.compound}%</div>
      </div>
      <div class="test-item ${data.lab.microbial === "Pass" ? "pass" : "fail"}">
        <div class="test-name">Microbial</div>
        <div class="test-value">${data.lab.microbial}</div>
      </div>
      <div class="test-item ${data.lab.heavyMetal === "Pass" ? "pass" : "fail"}">
        <div class="test-name">Heavy Metals</div>
        <div class="test-value">${data.lab.heavyMetal}</div>
      </div>
    `;
  }

  document.getElementById("paymentDetails").innerHTML = `
    <div class="payment-item">
      <div class="payment-value">â‚¹${data.quantity * 270}</div>
      <div class="payment-label">Farmer Payment</div>
    </div>
  `;

  showBatch([data.gps.lat, data.gps.lng], data.location);
}

function showBatch(coords, locationName) {
  document.getElementById("batchDetails").style.display = "block";
  document
    .getElementById("batchDetails")
    .scrollIntoView({ behavior: "smooth" });

  setTimeout(() => initMap(coords, locationName), 200);
}

function initMap(coords, locationName) {
  if (map) map.remove();

  map = L.map("map").setView(coords, 10);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "Â© OpenStreetMap contributors",
  }).addTo(map);

  L.marker(coords)
    .addTo(map)
    .bindPopup(`<b>${locationName}</b><br>Harvest Origin`)
    .openPopup();
}

// QR auto load
window.addEventListener("load", () => {
  const params = new URLSearchParams(window.location.search);
  const batchId = params.get("batch");
  if (batchId) {
    document.getElementById("batchInput").value = batchId;
    loadBatch(batchId.toUpperCase());
  }
});
</script>

<script type="module">
  import { connectWallet } from "./src/wallet.js";

  const btn = document.getElementById("connectWallet");

  btn.onclick = async () => {
    const addr = await connectWallet();
    btn.innerText = addr.slice(0, 6) + "..." + addr.slice(-4);
  };
</script>
  </body>
</html>
